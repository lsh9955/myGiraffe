# í¬íŒ… ë©”ë‰´ì–¼

# ğŸ—‚ï¸ ê°œìš”

## 1. í”„ë¡œì íŠ¸ ì‚¬ìš© ë„êµ¬

í˜•ìƒ ê´€ë¦¬ : Gitlab

ë°°í¬ í™˜ê²½ : EC2, Docker

CI/CD : Jenkins

í”„ë¡œë¹„ì €ë‹ : Ansible

## 2. ì™¸ë¶€ ì„œë¹„ìŠ¤

- Kakao Social Login
- Google Cloud Vision
- IMPort

## 3. git.ignore ì²˜ë¦¬ í•µì‹¬ í‚¤

: ì¤‘ê´„í˜¸â€™{ }â€™ ì•ˆì— ë‚´ìš©ë“¤ì€ ì™¸ë¶€ ë…¸ì¶œX

### React : .env (ìµœìƒë‹¨ ìœ„ì¹˜)

```bash
REACT_APP_KAKAOPAY_IMP=imp{ê³ ìœ ë²ˆí˜¸}
```

### Flask : .env (ìµœìƒë‹¨ ìœ„ì¹˜)

```bash
vision_api_key='{
  "type": "service_account",
  "project_id": "imageclassifier-379408",
  "private_key_id": "{ê³ ìœ ë²ˆí˜¸}",
  "private_key": "-----BEGIN PRIVATE KEY-----\n{ê³ ìœ ë²ˆí˜¸}\n-----END PRIVATE KEY-----\n",
  "client_email": "248146273851-compute@developer.gserviceaccount.com",
  "client_id": "102572273019876701671",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/248146273851-compute%40developer.gserviceaccount.com"
}'
```

### Springboot : (\src\main\resources ìœ„ì¹˜)

- auth : application-db.yml, application-oauth.yml, appliacation-jwt.yml
- books : application-db.yml
- store : application-db.yml
- user : application-db.yml, appliacation-jwt.yml

- application-db.yml

```bash
spring:
  # MariaDB
  datasource:
    url: jdbc:mariadb://{í˜¸ìŠ¤íŠ¸orë„ë©”ì¸}:{í¬íŠ¸ë²ˆí˜¸}/{ìŠ¤í‚¤ë§ˆ ì´ë¦„}
    username: {DB ì‚¬ìš©ì id}
    password: {ë¹„ë°€ë²ˆí˜¸}
    driver-class-name: org.mariadb.jdbc.Driver
  # JPA Properties
  jpa:
    hibernate:
      ddl-auto: update
      naming:
        implicit-strategy: org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy
    show-sql: true
    properties:
      hibernate:
        format_sql: true
  # Redis config
  redis:
    host: {í˜¸ìŠ¤íŠ¸orë„ë©”ì¸}
		password: {ë¹„ë°€ë²ˆí˜¸}
		port: {í¬íŠ¸ë²ˆí˜¸}
```

- application-oauth.yml

```bash
spring:
  # OAuth2
  security:
    oauth2:
      client:
        registration:
          kakao:
            client-id: {REST API í‚¤}
            client-secret: {ì‹œí¬ë¦¿ í‚¤} (ì„ íƒ)
            redirect-uri: http://{í˜¸ìŠ¤íŠ¸orë„ë©”ì¸}:{í¬íŠ¸ë²ˆí˜¸}/login/oauth2/code/kakao
            authorization-grant-type: authorization_code
            client-authentication-method: POST
            client-name: kakao
            scope:
              - profile_image
              - profile_nickname
        provider:
          kakao:
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
            user-info-uri: https://kapi.kakao.com/v2/user/me
            user-name-attribute: id
```

- application-jwt.yml

```bash
# jwt
jwt:
  header: Authorization
  secret: {HS256ìœ¼ë¡œ í•´ë…ê°€ëŠ¥í•œ í‚¤(Base64 ì¸ì½”ë”©, 512byte ì´ìƒ)}
  token-validity-in-seconds: 3600 # 1ì‹œê°„ ìœ íš¨
```

## 4. ë¡œì»¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

> Git ì—ì„œ Clone ì´í›„ì— ë¡œì»¬ì—ì„œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•˜ì—¬ ì„œìˆ í•©ë‹ˆë‹¤.
>
> 1. ê¹ƒì—ì„œ í´ë¡ ìš© ì£¼ì†Œë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤.
>    ![Untitled](/assets/Untitled.png)
>
> 1. git Bash (ë¯¸ì„¤ì¹˜ì‹œ êµ¬ê¸€ë§ í›„ ì„¤ì¹˜)ë¥¼ í†µí•´ í´ë¡ í•©ë‹ˆë‹¤.
>    ![Untitled 1](/assets/Untitled%201.png)

### 1) Front: React

![Untitled 2](https://i.imgur.com/QzS553P.png)

1. git bashë¡œ ì‹¤í–‰í•˜ê¸°
   1. `npm i`
      ![Untitled 3](https://i.imgur.com/9aelig6.png)
   2. `npm start`
      ![Untitled 4](https://i.imgur.com/PsAmJrd.png)
   3. ì´í›„ [`http://localhost:3000/`](http://localhost:3000/login) ìœ¼ë¡œ Front ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
      ![Untitled 5](https://i.imgur.com/LK0payS.png)
   4. ë¡œì»¬ í™˜ê²½ì—ì„œ Front êµ¬ë™ ì™„ë£Œ
      ![Untitled 6](https://i.imgur.com/PzCFUpW.png)
2. VS Codeë¡œ ì‹¤í–‰

   ìœ„ì™€ ë™ì¼í•œ ì½”ë“œë¥¼ VScodeì˜ í„°ë¯¸ë„ ì°½ì—ì„œ ì‘ì„±í•©ë‹ˆë‹¤.
   ![Untitled 7](https://i.imgur.com/vv38uug.png)

### 2) ML: Flask

> MicroServiceëŠ” ë°°í¬ìš© ì´ê¸° ë•Œë¬¸ì—, ë¡œì»¬ ì„œë²„ìš©ì¸ ML_server ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.

1. app.pyê°€ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬ê¹Œì§€ ì ‘ê·¼ í•©ë‹ˆë‹¤.
   ![Untitled 8](https://i.imgur.com/rbmPT2E.png)
2. `python -m venv venv` : ê°€ìƒí™˜ê²½ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
   ![Untitled 9](https://i.imgur.com/1vkNScK.png)

3. `source venv/Script/activate` : ê°€ìƒí™˜ê²½ì„ ì‘ë™ì‹œì¼œì¤ë‹ˆë‹¤.
   ![Untitled 10](https://i.imgur.com/8SykRh0.png)
   â†’ ë§Œì•½ venvê°€ ì •ìƒ ì‘ë™í•˜ë©´ ìœ„ì— (venv) ê°€ ë¶™ìŠµë‹ˆë‹¤.
4. `pip install -r requirements.txt` í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•´ì¤ë‹ˆë‹¤.
   ![Untitled 11](https://i.imgur.com/kE3DYsM.png)
5. `python [app.py](http://app.py)` : app.pyë¥¼ ì‹¤í–‰í•´ì¤ë‹ˆë‹¤.
   - Tip!
     > ë§Œì•½ ì˜¤ë¥˜ê°€ ë‚¬ë‹¤? â†’ .env íŒŒì¼ì˜ ë¶€ì¬ì¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.
     >
     > ![Untitled 12](https://i.imgur.com/wNJUeyS.png)
     â†’ ì´ë ‡ê²Œ vision_api_key ì˜¤ë¥˜ê°€ ë‚¬ë‹¤ë©´, ìœ— ë‹¨ë½ì˜ .gitignore ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.

### 3) Back: Spring Boot

1. git bash/cmdë¡œ ì‹¤í–‰í•˜ê¸°
   1. cd /project/ê²½ë¡œ/
   2. ./gradlew build
   3. cd build/libs
   4. java -jar 'jaríŒŒì¼ëª….jarâ€™
2. InteliJë¡œ ì‹¤í–‰í•˜ê¸°

   1. build.gradle - as Projectë¡œ ì—´ê¸°
      ![Untitled 13](https://i.imgur.com/fphB5pD.png)

   2. Project Structure - Project Settings - Project SDK: JDK 17 í™•ì¸
      ![Untitled 14](https://i.imgur.com/APOtrxQ.png)

   3. Settings - Build, Execution, Deployment - Gradle - Gradle JVM : JDK 17 í™•ì¸
      ![Untitled 15](https://i.imgur.com/9M2XQod.png)

   4. ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (Alt + Shift + F10)
      ![Untitled 16](https://i.imgur.com/wiaHIoi.png)

# ğŸ’¾ ë°°í¬í™˜ê²½ ì„¤ì¹˜

: EC2 ë‚´ë¶€ ssh ì ‘ì†

## 1. Docker ì„¤ì¹˜

```bash
# Docker ì„¤ì¹˜í•˜ê¸°
## ì´ì „ Docker ìˆìœ¼ë©´ ì‚­ì œ
sudo apt-get remove docker docker-engine docker.io containerd runcCopy

## Docker engine ì„¤ì¹˜ì— í•„ìš”í•œ íˆ´ ì„¤ì¹˜
sudo apt update
sudo apt-get install -y ca-certificates \
    curl \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release

sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

## Docker engine ì„¤ì¹˜
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
cat <<EOF | sudo tee /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF

## Docker ê¶Œí•œ ì„¤ì •
curl -fsSL https://get.docker.com/ | sudo sh
sudo usermod -aG docker $USER
newgrp docker

# Docker Compose ì„¤ì¹˜
sudo apt-get update
sudo apt-get install docker-compose-plugin

## ì„¤ì¹˜ í™•ì¸
docker compose version
```

## 2. Jenkins ì»¨í…Œì´ë„ˆ ì„¤ì¹˜

```bash
docker run --privileged --name jenkins-server --link ansible-server -itd \
 -p 8088:8088 -p 50000:50000 --env JENKINS_OPTS=--httpPort=8088 \
 -v jenkins_home:/var/jenkins_home \
 -v /usr/bin/docker:/usr/bin/docker \
 -v /var/run/docker.sock:/var/run/docker.sock \
 --restart=on-failure jenkins/jenkins:lts-jdk17
```

## 3. DataBase

### MariaDB ì»¨í…Œì´ë„ˆ ì„¤ì¹˜

```bash
docker run --name mariadb-server \
        -d -p 3310:3306 \
    -e MARIADB_ROOT_PASSWORD={ROOT ë¹„ë°€ë²ˆí˜¸}\
    -e MARIADB_DATABASE={ìŠ¤í‚¤ë§ˆ} \
    -e MARIADB_USER={DB ì‚¬ìš©ì} \
    -e MARIADB_PASSWORD={ë¹„ë°€ë²ˆí˜¸} \
    --mount source=mariadb-data,target=/var/lib/mysql \
  mariadb:latest \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci
```

- ê¶Œí•œ ë¶€ì—¬

```bash
mysql -u root -p > pw ì…ë ¥í•˜ë©´ db ì ‘ì†

grant all privileges on 'DBëª…'.* to 'userëª…'@'%';
```

### mongoDB ì»¨í…Œì´ë„ˆ ì„¤ì¹˜

```bash
docker run --name mongodb-server -d -p 34567:27017 \
 -e MONGO_INITDB_DATABASE={ìŠ¤í‚¤ë§ˆ} \
 --mount source=mongodb-data,target=/data/db mongo
```

### Redis ì»¨í…Œì´ë„ˆ ì„¤ì¹˜

```bash
docker run --name redis-server -d -p 6399:6379
```

## 4. Nginx ì„¤ì¹˜ (native)

```bash
sudo apt install nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### ì„¤ì •íŒŒì¼ ê´€ë¦¬

```bash
cd /etc/nginx/conf.d
rm default.conf # ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ë³¸ ì„¤ì •íŒŒì¼ ì‚­ì œ
sudo vi {ì„ì˜ì„¤ì •}.conf
```

```bash
server {
        listen 80;
        server_name {domain};

        return 308 https://$host$request_uri;   # httpë¡œ ë“¤ì–´ì˜¤ë©´ httpsë¡œ redirect í•´ì£¼ëŠ” ë¶€ë¶„
}
server {
        listen 443 ssl;
        server_name {domain};

        access_log /var/log/nginx/proxy/access.log;
        error_log /var/log/nginx/proxy/error.log;

        charset utf-8;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;

        # Certificate
        ssl_certificate /etc/letsencrypt/live/{domain}/fullchain.pem;

        # Private Key
        ssl_certificate_key /etc/letsencrypt/live/{domain}/privkey.pem;

        # api ìš”ì²­
        location /api {
                location /api/aivoice {
                        proxy_pass http://localhost:5010;
                }
                location /api/classifier {
                        proxy_pass http://localhost:5020;
                }
                location /api/numbers {
                        proxy_pass http://localhost:5030;
                }
                location /api/visionapi {
                        proxy_pass http://localhost:5030;
                }
                location /api/auth {
                        proxy_pass http://localhost:9001;
                }
                location /api/resources {
                        proxy_pass http://localhost:9031;
                }
                location /api/books {
                        proxy_pass http://localhost:9021;
                }
                location /api/members {
                        proxy_pass http://localhost:9011;
                }
                #proxy_pass http://localhost:9900;
        }
        # ë©”ì¸ í˜ì´ì§€
        location / {
                proxy_pass http://localhost:3010;
        }
}                                                                                                                      1,8           Top
```

### SSL ì¸ì¦ì„œ ë°œê¸‰ â†’ certbot

```bash
apt-get update
sudo apt-get install certbot
apt-get install python3-certbot-nginx
sudo certbot --nginx --email {ì´ë©”ì¼} --agree-tos
```

â†’ ì´ë©”ì¼ ì†Œì‹ ë°›ì•„ë³´ê¸° : N

â†’ Nginxì— ë“±ë¡ëœ í˜¸ìŠ¤íŠ¸ ëª©ë¡ ëª¨ë‘ ì¸ì¦ ë°›ê¸° : Enter

â†’ ìë™ìœ¼ë¡œ Httpsë¡œ Redirect ì„¤ì • : 2

### Nginx ì¬ì‹œì‘ â†’ ì„¤ì • ë°˜ì˜ (reload ê¶Œì¥)

```bash
sudo nginx -s reload
ë˜ëŠ”
sudo systemctl restart nginx
ë˜ëŠ”
sudo service nginx restart
```

## 5. Ansible ì»¨í…Œì´ë„ˆ ì„¤ì¹˜

```bash
docker run --privileged --name ansible-server -itd \
 -p 20022:22 -p 8089:8080 -e container=docker \
 -v /sys/fs/cgroup:/sys/fs/cgroup edowon0623/ansible:latest /usr/sbin/in
```

### CI/CD êµ¬ì„± íŒŒì¼

- Ansible ì»¨í…Œì´ë„ˆ /root ìœ„ì¹˜

- Dockerfile-Front
  ```bash
  FROM nginx

  RUN mkdir /app

  WORKDIR /app

  RUN mkdir ./build

  COPY ./.dockerimage-front/build/ ./build/

  RUN rm /etc/nginx/conf.d/default.conf

  COPY ./nginx.conf /etc/nginx/conf.d

  EXPOSE 80

  CMD ["nginx", "-g", "daemon off;"]
  ```
- Dockerfile-{Flask}
  ```bash
  FROM python:3.9-slim

  COPY ./.dockerimage-{ì„œë²„ì´ë¦„ ex) classifier} /app

  WORKDIR /app

  RUN pip install -r requirements.txt

  CMD ["python", "app.py"]
  ```
- Dockerfile-{Springboot}

  ```bash
  FROM amazoncorretto:17

  COPY ./.dockerimage-{ì„œë²„ì´ë¦„ ex) auth}/app.jar app.jar

  ENTRYPOINT ["java", "-Duser.timezone=Asia/Seoul", "-jar", "/app.jar"]
  ```

- Ansible ì»¨í…Œì´ë„ˆ /root/playbooks ìœ„ì¹˜

- front.yml
  mjun111/cicd:front â†’ ê°œì¸ Docker hub Repository:tag
  ```bash
  - hosts: ansible

    tasks:
      - name: build a docker image with develop react build
        command: docker build -t mjun111/cicd:front -f Dockerfile-Front .
        args:
          chdir: /root

      - name: push the image on Docker Hub
        command: docker push mjun111/cicd:front

      - name: remove the docker image from the ansible server
        command: docker rmi mjun111/cicd:front
        ignore_errors: yes

      - name: remove the build file from the ansible server
        command: rm -rf /root/.dockerimage-front
        ignore_errors: yes

  - hosts: ec2

    tasks:
      - name: stop current running container
        command: docker stop front-server
        ignore_errors: yes

      - name: remove stopped container
        command: docker rm front-server
        ignore_errors: yes

      - name: remove current docker image
        command: docker rmi mjun111/cicd:front
        ignore_errors: yes

      - name: pull and create the newest docker image from Docker Hub
        command: docker run --privileged --name front-server -itd -p 3010:80 mjun111/cicd:front
  ```
- ml-{Flask ì„œë²„ ì´ë¦„ ex) classifier}.yml
  ```bash
  - hosts: ansible

    tasks:
      - name: build a docker image with develop flask build
        command: docker build -t mjun111/cicd:ml-classifier -f Dockerfile-Classifier .
        args:
          chdir: /root

      - name: push the image on Docker Hub
        command: docker push mjun111/cicd:ml-classifier

      - name: remove the docker image from the ansible server
        command: docker rmi mjun111/cicd:ml-classifier
        ignore_errors: yes

      - name: remove the build file from the ansible server
        command: rm -rf /root/.dockerimage-classifier
        ignore_errors: yes

  - hosts: ec2

    tasks:
      - name: stop current running container
        command: docker stop ml-classifier
        ignore_errors: yes

      - name: remove stopped container
        command: docker rm ml-classifier
        ignore_errors: yes

      - name: remove current docker image
        command: docker rmi mjun111/cicd:ml-classifier
        ignore_errors: yes

      - name: pull and create the newest docker image from Docker Hub
        command: docker run --privileged --name ml-classifier -itd -p 5020:5000 mjun111/cicd:ml-classifier
  ```
- {SpringBoot ì„œë²„ì´ë¦„}.yml
  ```bash
  - hosts: ansible

    tasks:
      - name: build a docker image with develop user-server build
        command: docker build -t mjun111/cicd:user -f Dockerfile-User .
        args:
          chdir: /root

      - name: push the image on Docker Hub
        command: docker push mjun111/cicd:user

      - name: remove the docker image from the ansible server
        command: docker rmi mjun111/cicd:user
        ignore_errors: yes

      - name: remove the jar file from the ansible server
        command: rm -rf /root/.dockerimage-user
        ignore_errors: yes

  - hosts: ec2

    tasks:
      - name: stop current running container
        command: docker stop user-server
        ignore_errors: yes

      - name: remove stopped container
        command: docker rm user-server
        ignore_errors: yes

      - name: remove current docker image
        command: docker rmi mjun111/cicd:user
        ignore_errors: yes

      - name: pull and create the newest docker image from Docker Hub
        command: docker run --privileged --name user-server -itd -p 9011:8085 mjun111/cicd:user
  ```

# âœï¸ ì„œë¹„ìŠ¤ ì´ìš© ë°©ë²•

## 1. Kakao Social Login

### 1) [kakao developers](https://www.notion.so/47d78fe40cda4510be7159cbb41d1515) - ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì†

### 2) ì• í”Œë¦¬ì¼€ì´ì…˜ ì¶”ê°€í•˜ê¸°

### 3) REST API í‚¤ í™•ì¸

![Untitled 17](https://i.imgur.com/NmvpfS6.png)

### 4) Redirect URI ì„¤ì •

![Untitled 18](https://i.imgur.com/fTdXHRi.png)

### 5) ë™ì˜ í•­ëª© - ë°›ì•„ì˜¬ ê°œì¸ ì •ë³´ ì„¤ì •

![Untitled 19](https://i.imgur.com/ZJICWRm.png)

### 6) Spring Boot Flow

> ëª¨ë“  ê³¼ì •ì€ **Spring Security Filter** ê³¼ì •ì—ì„œ ìˆ˜í–‰ â†’ Login ControllerëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŒ

1. ê°€ì¥ë¨¼ì € OAuth2 Login Authentication Filterì—ì„œ OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì´ ìˆ˜í–‰
2. OAuth2 Filter ë‹¨ì—ì„œ ì§ì ‘ ì»¤ìŠ¤í…€í•œ OAuth2 Serviceì˜ "loadUser"ë©”ì†Œë“œê°€ ì‹¤í–‰
3. ë¡œê·¸ì¸ì„ ì„±ê³µí•˜ê²Œ ë˜ë©´ Success Handlerì˜ "onAuthenticationSuccess" ë©”ì†Œë“œê°€ ì‹¤í–‰
4. Success Handlerì—ì„œ ìµœì´ˆ ë¡œê·¸ì¸ í™•ì¸ ë° JWT ìƒì„± ë° ì‘ë‹µ ê³¼ì •ì´ ì‹¤í–‰
   >

<details close> 
<summary> <b style="font-size:18px;"> êµ¬í˜„ ì½”ë“œ </b></summary>
### build.gradle

```java
dependencies {

	implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-validation'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'io.jsonwebtoken:jjwt-api:0.11.2'
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.2'
	runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.2'
	compileOnly 'org.projectlombok:lombok'
	developmentOnly 'org.springframework.boot:spring-boot-devtools'
	runtimeOnly 'mysql:mysql-connector-java'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
}
```

### application-oauth.yml

```bash
spring:
  # OAuth2
  security:
    oauth2:
      client:
        registration:
          kakao:
            client-id: ~~~
            client-secret: ~~~
            # ìš”ì²­ http://localhost:8090/oauth2/authorization/kakao
            # http://192.168.31.64:8090/oauth2/authorization/kakao
            redirect-uri: http://192.168.31.64:8090/login/oauth2/code/kakao
            authorization-grant-type: authorization_code
            client-authentication-method: POST
            client-name: Kakao
            scope:
              - profile_image
              - profile_nickname
              - account_email
        provider:
          kakao:
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
            user-info-uri: https://kapi.kakao.com/v2/user/me
            user-name-attribute: id

# jwt SsarijileoSecretKey 20 Fin
jwt:
  header: Authorization
  secret: ~~~
  token-validity-in-seconds: 3600
```

### SecurityConfig

```java
@RequiredArgsConstructor
@Configuration
public class SecurityConfig {
    private final CustomOAuth2UserService oAuth2UserService;
    private final OAuth2SuccessHandler successHandler;
    private final TokenProvider tokenProvider;

		// ì›¹ ì‹œíë¦¬í‹° ì„¤ì • -> íŠ¹ì • í˜ì´ì§€ ì‹œíë¦¬í‹° í•„í„°ì—ì„œ ì œì™¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©
    @Bean
    public WebSecurityCustomizer configure() {
        return (web) -> web.ignoring()
            .antMatchers(
                "/favicon.ico",
                "/error",
                "/swagger-resources/**",
                "/swagger-ui/**",
                "/v3/api-docs",
                "/webjars/**"
            )
            .and()
            .ignoring().requestMatchers(PathRequest.toStaticResources().atCommonLocations());    // ì •ì ì¸ ë¦¬ì†ŒìŠ¤ë“¤ì— ëŒ€í•´ì„œ ì‹œíë¦¬í‹° ì ìš© ë¬´ì‹œ.
    }

    @Bean
    protected SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        // cors ì„¤ì •
        http.cors().configurationSource(request -> new CorsConfiguration().applyPermitDefaultValues())
            .and()
        // REST ë°©ì‹ ì‚¬ìš© -> csrf, formë¡œê·¸ì¸, ì„¸ì…˜ ë¬´ì‹œ
            .httpBasic().disable()
                .csrf().disable()
                .formLogin().disable()
                .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
        // token ê²€ì¦í•˜ëŠ” í˜ì´ì§€&ë©”ì¸í˜ì´ì§€ëŠ” ì¸ê°€ í—ˆê°€, ì™¸ì—” ëª¨ë‘ ì¸ê°€ í•„ìš”
                .authorizeRequests()
                .antMatchers("/token/**").permitAll()
                .antMatchers("/").permitAll()
                .anyRequest().authenticated()
            .and()
                .logout().logoutSuccessUrl("/")
            .and()
				// OAuth2 ë¡œê·¸ì¸
                .oauth2Login()
                .successHandler(successHandler)
                .userInfoEndpoint()
                .userService(oAuth2UserService);

        http.addFilterBefore(new JwtAuthFilter(tokenProvider), UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
```

### OAuth2UserService

```java
@Slf4j
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        //  1ë²ˆ
        OAuth2UserService<OAuth2UserRequest, OAuth2User> oAuth2UserService = new DefaultOAuth2UserService();

        //	2ë²ˆ
        OAuth2User oAuth2User = oAuth2UserService.loadUser(userRequest);
        log.info("oAuth2User = {}", oAuth2User);

        //	3ë²ˆ
        String registrationId = userRequest.getClientRegistration().getRegistrationId();
        String userNameAttributeName = userRequest.getClientRegistration()
                .getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName();
        log.info("registrationId = {}", registrationId);
        log.info("userNameAttributeName = {}", userNameAttributeName);

        // 4ë²ˆ
        OAuth2Attribute oAuth2Attribute =
                OAuth2Attribute.of(registrationId, userNameAttributeName, oAuth2User.getAttributes());

        var memberAttribute = oAuth2Attribute.convertToMap();

        return new DefaultOAuth2User(
                Collections.singleton(new SimpleGrantedAuthority(Role.USER.getKey())),
                memberAttribute, "id");
    }
}
```

### OAuth2Attribute

```java
@ToString
@Getter
@Builder(access = AccessLevel.PRIVATE)
public class OAuth2Attribute {
    private Map<String, Object> attributes;
    private String id;
    private String attributeKey;
    private String email;
    private String nickname;
    private String image;

    static OAuth2Attribute of(String provider, String attributeKey,
                              Map<String, Object> attributes) {
        switch (provider) {
            case "google":
                return ofGoogle(attributeKey, attributes);
            case "kakao":
                return ofKakao(attributeKey, attributes);
            case "naver":
                return ofNaver("id", attributes);
            default:
                throw new RuntimeException();
        }
    }

    private static OAuth2Attribute ofGoogle(String attributeKey,
                                            Map<String, Object> attributes) {
        return OAuth2Attribute.builder()
                .nickname((String) attributes.get("name"))
                .email((String) attributes.get("email"))
                .attributes(attributes)
                .attributeKey(attributeKey)
                .build();
    }

    private static OAuth2Attribute ofKakao(String attributeKey,
                                           Map<String, Object> attributes) {
        Map<String, Object> kakaoAccount = (Map<String, Object>) attributes.get("kakao_account");
        Map<String, Object> kakaoProfile = (Map<String, Object>) kakaoAccount.get("profile");

        return OAuth2Attribute.builder()
                .id(String.valueOf(attributes.get("id")))
                .nickname((String) kakaoProfile.get("nickname"))
                .email((String) kakaoAccount.get("email"))
                .image((String)kakaoProfile.get("profile_image_url"))
                .attributes(kakaoAccount)
                .attributeKey(attributeKey)
                .build();
    }

    private static OAuth2Attribute ofNaver(String attributeKey,
                                           Map<String, Object> attributes) {
        Map<String, Object> response = (Map<String, Object>) attributes.get("response");

        return OAuth2Attribute.builder()
                .nickname((String) response.get("name"))
                .email((String) response.get("email"))
                .attributes(response)
                .attributeKey(attributeKey)
                .build();
    }

    Map<String, Object> convertToMap() {
        Map<String, Object> map = new HashMap<>();
        map.put("id", id);
        map.put("key", attributeKey);
        map.put("nickname", nickname);
        map.put("email", email);
        map.put("image", image);

        return map;
    }
}
```

### OAuth2SuccessHandler

```java
@Slf4j
@RequiredArgsConstructor
@Transactional
@Component
public class OAuth2SuccessHandler extends SimpleUrlAuthenticationSuccessHandler {
    private final UserRepository userRepository;
    private final TokenProvider tokenProvider;
    private final UserRequestMapper userRequestMapper;
    private String redirectUrl = "http://localhost:3000";

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication)
        throws IOException {
        OAuth2User oAuth2User = (OAuth2User)authentication.getPrincipal();
        log.info("[!] oAuth2User = {}",oAuth2User);
        log.info("[!] attributes = {}",oAuth2User.getAttributes());

        UserDto userDto = UserDto.builder()
            .socialId(String.valueOf(oAuth2User.getAttributes().get("id")))
            .build();

        UserInfoDto userInfoDto = userRequestMapper.toDto(oAuth2User);

        User guest = new User();

        Token tokens = new Token();

        // íšŒì› ì •ë³´ ë°›ì•„ì˜´
        User user = userRepository.findBySocialId(userDto.getSocialId()).orElse(guest);

        // ìµœì´ˆ ë¡œê·¸ì¸ì´ë¼ë©´ íšŒì›ê°€ì… ì²˜ë¦¬ë¥¼ í•œë‹¤.
        if (user.equals(guest)) {
            // íšŒì› ì •ë³´ ì €ì¥
            userRepository.save(userDto.toUser(userDto));

            // ì €ì¥ëœ íšŒì› ì •ë³´ ë¶ˆëŸ¬ì˜´ -> userId ì‚¬ìš©
            user = userRepository.findBySocialId(userDto.getSocialId()).orElseThrow(NotFoundException::new);

            userInfoDto.updateUserId(String.valueOf(user.getUserId()));

            // í† í° ë°œí–‰
            tokens = tokenProvider.generateToken(userInfoDto, Role.USER.getKey());

            // ë¦¬í”„ë ˆì‹œ í† í° ìºì‹œ ì €ì¥
            tokenProvider.setSaveRefresh(String.valueOf(user.getUserId()),
                tokens.getRefreshToken(), tokenProvider.getExpiration(TokenKey.REFRESH));

        } else {
            userInfoDto.updateUserId(String.valueOf(user.getUserId()));

            String access = tokenProvider.generateAccess(userInfoDto, Role.USER.getKey());

            // ë¦¬í”„ë ˆì‹œ í† í° ìœ íš¨í•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ ì¬ë°œí–‰
            String refresh = tokenProvider.getSavedRefresh(String.valueOf(user.getUserId()));
            if (refresh != null && tokenProvider.validateToken(refresh) == JwtCode.ACCESS) {
                tokens = tokens.builder().accessToken(access)
                    .refreshToken(refresh).build();
            } else {
                tokens = tokenProvider.generateToken(userInfoDto, Role.USER.getKey());
            }
        }

        String targetUrl;
        targetUrl = UriComponentsBuilder.fromUriString(redirectUrl)
            .queryParam(TokenKey.ACCESS.getKey(), "Bearer " + tokens.getAccessToken())
            .queryParam(TokenKey.REFRESH.getKey(), "Bearer " + tokens.getRefreshToken())
            .build().toUriString();

        // í”„ë¡ íŠ¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        getRedirectStrategy().sendRedirect(request, response, targetUrl);
    }
}
```

### Token

```java
@ToString
@NoArgsConstructor
@Getter
@Builder
public class Token {
    private String accessToken;
    private String refreshToken;

    public Token(String accessToken, String refreshToken) {
        this.accessToken = accessToken;
        this.refreshToken = refreshToken;
    }
}
```

### JwtCode

```java
@Getter
public enum JwtCode {
	DENIED,
	ACCESS,
	EXPIRED;
}
```

### Role

```java
@Getter
@RequiredArgsConstructor
public enum Role {

    GUEST("ROLE_GUEST","ì†ë‹˜"),
    USER("ROLE_USER","ì¼ë°˜ ì‚¬ìš©ì");

    private final String key;
    private final String title;
}
```

### TokenKey

```java
@Getter
@RequiredArgsConstructor
public enum TokenKey {
	ACCESS("Authorization"), REFRESH("refreshToken");

	private String key;

	TokenKey(String key) {
		this.key = key;
	}
}
```

### TokenProvider

```java
@Service
@Slf4j
public class TokenProvider implements InitializingBean {
    private final String secret;
    private final long tokenValidityInMilliseconds;     // 30 min
    private final RedisService redisService;
    private Key key;

    @Autowired
    public TokenProvider(
        @Value("${jwt.secret}")String secret,
        @Value("${jwt.token-validity-in-seconds}")long tokenValidityInSeconds,
        RedisService redisService
    ) {
        this.secret = secret;
        this.tokenValidityInMilliseconds = tokenValidityInSeconds * 1000;
        this.redisService = redisService;
    }

    @Override
    public void afterPropertiesSet() {
        byte[] keyBytes = Decoders.BASE64.decode(secret);
        this.key = Keys.hmacShaKeyFor(keyBytes);
    }

    public String getSavedRefresh(String key) {
        return redisService.getData(key);
    }

    public void setSaveRefresh(String key, String value, Long time) {
        redisService.setDataWithExpiration(key, value, time);
    }

    public String generateAccess(UserInfoDto userInfo, String role) {
        return createToken(userInfo, role, TokenKey.ACCESS);
    }

    public String generateRefresh(UserInfoDto userInfo, String role) {
        return createToken(userInfo, role, TokenKey.REFRESH);
    }

    public Token generateToken(UserInfoDto userInfo, String role) {
        String accessToken = generateAccess(userInfo, role);
        String refreshToken = generateRefresh(userInfo, role);

        return new Token(accessToken, refreshToken);
    }

    public String createToken(UserInfoDto userInfo, String role, TokenKey tokenKey) {
        // access : 30 min, refresh : 1 month
        long period = getExpiration(tokenKey);

        Claims claims = Jwts.claims().setSubject(userInfo.getUserId());
        claims.put("role", role);

        Date now = new Date();

        return Jwts.builder()
            .setClaims(claims)
            .setIssuedAt(now)
            .setExpiration(new Date(now.getTime() + period))
            .signWith(key, SignatureAlgorithm.HS256)
            .compact();
    }

    public JwtCode validateToken(String token) {
        try {
            Jwts.parserBuilder()
                .setSigningKey(secret)
                .build()
                .parseClaimsJws(token);
            return JwtCode.ACCESS;
        } catch (ExpiredJwtException e) {
            // ë§Œë£Œëœ ê²½ìš°ì—ëŠ” refresh tokenì„ í™•ì¸í•˜ê¸° ìœ„í•´
            return JwtCode.EXPIRED;
        } catch (JwtException | IllegalArgumentException  e) {
            log.info("jwtException = {}", e);
        }
        return JwtCode.DENIED;
    }

    public String getUid(String token) {
        return Jwts.parserBuilder().setSigningKey(secret).build().parseClaimsJws(token).getBody().getSubject();
    }

    public Claims getClaims(String token) {
        return Jwts.parserBuilder().setSigningKey(secret).build().parseClaimsJws(token).getBody();
    }

    public Long getExpiration(TokenKey tokenKey) {

        String delimiter = tokenKey.getKey();
        if (delimiter.equals(TokenKey.ACCESS.getKey())) {
            return tokenValidityInMilliseconds;
        } else if (delimiter.equals(TokenKey.REFRESH.getKey())) {
            return tokenValidityInMilliseconds * 2L * 24L * 30;
        } else {
            throw new RuntimeException();
        }
    }

    public String resolveToken(String bearerToken) {
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

### JwtAuthFilter

```java
@Slf4j
@RequiredArgsConstructor
public class JwtAuthFilter extends GenericFilterBean {

    private final TokenProvider tokenProvider;

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        String token = tokenProvider.resolveToken(((HttpServletRequest)request).getHeader(TokenKey.ACCESS.getKey()));

        if (token != null && tokenProvider.validateToken(token) == JwtCode.ACCESS) {
            String userId = tokenProvider.getUid(token);

            UserDto userDto = UserDto.builder()
                    .userId(userId)
                    .build();

            Authentication auth = getAuthentication(userDto);
            SecurityContextHolder.getContext().setAuthentication(auth);
            log.info("set Authentication to security context for '{}', uri = {}", auth.getName(), ((HttpServletRequest)request).getRequestURI());
        } else if (token != null && tokenProvider.validateToken(token) == JwtCode.EXPIRED) {
            Claims claims = tokenProvider.getClaims(token);

            // í† í°ì— ì €ì¥ëœ ìœ ì €ì •ë³´
            UserInfoDto userInfoDto = UserInfoDto.builder()
                    .userId(claims.getSubject())
                    .build();

            // í—¤ë”ì— ì¡´ì¬í•˜ëŠ” ë¦¬í”„ë ˆì‹œ í† í°
            String refresh = tokenProvider.resolveToken(
                ((HttpServletRequest)request).getHeader(TokenKey.REFRESH.getKey()));

            // ìºì‹œì— ì¡´ì¬í•˜ëŠ” ë¦¬í”„ë ˆì‹œ í† í°
            String savedRefresh = tokenProvider.getSavedRefresh(userInfoDto.getUserId());

            // refresh tokenì„ í™•ì¸í•´ì„œ ì¬ë°œê¸‰
            if (token != null && refresh.equals(savedRefresh) && tokenProvider.validateToken(refresh) == JwtCode.ACCESS) {
                Token tokens = tokenProvider.generateToken(userInfoDto, Role.USER.getKey());

                tokenProvider.setSaveRefresh(userInfoDto.getUserId(),
                    tokens.getRefreshToken(), tokenProvider.getExpiration(TokenKey.REFRESH));

                ((HttpServletResponse)response).setHeader(TokenKey.ACCESS.getKey(), "Bearer " + tokens.getAccessToken());
                ((HttpServletResponse)response).setHeader(TokenKey.REFRESH.getKey(), "Bearer " + tokens.getRefreshToken());

                UserDto userDto = UserDto.builder()
                    .userId(userInfoDto.getUserId())
                    .build();

                Authentication auth = getAuthentication(userDto);
                SecurityContextHolder.getContext().setAuthentication(auth);
                log.info("set Authentication to security context for '{}', uri = {}", auth.getName(), ((HttpServletRequest)request).getRequestURI());
            }
        } else {
            log.info("no valid JWT token found, uri: {}", ((HttpServletRequest)request).getRequestURI());
        }
        chain.doFilter(request, response);
    }

    public Authentication getAuthentication(UserDto member) {
        return new UsernamePasswordAuthenticationToken(member, "",
                Arrays.asList(new SimpleGrantedAuthority(Role.USER.getKey())));
    }
}
```

</details>

### 7) Front ë¡œê·¸ì¸ ë²„íŠ¼ì— ìš”ì²­ URI ì—°ê²°

![Untitled 20](https://i.imgur.com/5yqrvpI.png)
![Untitled 21](https://i.imgur.com/ihrqjYA.png)
![Untitled 22](https://i.imgur.com/xpSoC4S.png)

## 2. Google Cloud Vision

> GCPë¥¼ í™œìš©í•œ ë‹¤ì–‘í•œ ê¸°ëŠ¥ ì¤‘ Vision APIì— ëŒ€í•œ ì„¤ëª…
> ![Untitled 23](https://i.imgur.com/3N3Nwne.png)

### 1) í”„ë¡œì íŠ¸ ìƒì„±

> í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ì—†ë‹¤ë©´, ë¨¼ì € ìƒì„±í•´ì¤ë‹ˆë‹¤.
>
> ë³¸ í”„ë¡œì íŠ¸ëŠ” imageclassifierë¼ëŠ” í”„ë¡œì íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
>
> ![Untitled 24](https://i.imgur.com/AAZFQM5.png)
> ![Untitled 25](https://i.imgur.com/ZqRmZYT.png)
> ![Untitled 26](https://i.imgur.com/XeQmb0i.png)

### 2) API ì—°ê²°

1. í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê³  API ì„œë¹„ìŠ¤ì— ì ‘ì†í•©ë‹ˆë‹¤.
   ![Untitled 27](https://i.imgur.com/usZwXjp.png)

1. APIë¥¼ ì—°ê²°í•  ì„œë¹„ìŠ¤ë¥¼ ì •í•˜ê³ 

![Untitled 28](https://i.imgur.com/KbB8Ptg.png)

1. ìƒì„¸ ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.

![Untitled 29](https://i.imgur.com/sxrFXmo.png)

1. ë§ì€ ëª¨ë¸ ì¤‘ì—ì„œ Visionê³¼ ì—°ê²°í•´ë³´ê² ìŠµë‹ˆë‹¤.

![Untitled 30](https://i.imgur.com/CRi39nM.png)

### 3) í”„ë¡œì íŠ¸ API ìƒíƒœ ê´€ë¦¬

> íŠ¹ì´ ê°’ì´ ìˆìœ¼ë©´ ì¼€ì–´í•©ì‹œë‹¤. í•˜ì§€ ì•Šìœ¼ë©´ ëˆì­ì´ ë‚©ë‹ˆë‹¤.
>
> ![Untitled 31](https://i.imgur.com/a3oH8Cr.png)

### 4) [ì¤‘ìš”] pythonìœ¼ë¡œ API ì—°ê²°

> Vision ì´ì™¸ì˜ ìš”ì†ŒëŠ” ìƒëµ

1. í™˜ê²½ ì„¸íŒ…í•˜ê¸°. (.env íŒŒì¼ì˜ API í‚¤ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.)

```python
# app.py
from dotenv import load_dotenv
from google.cloud import vision
from google.oauth2 import service_account

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
vision_api_key = os.environ.get("vision_api_key")

# JSON ë¬¸ìì—´ì„ íŒŒì´ì¬ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
vision_api_key = json.loads(vision_api_key)

# ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ê²½ë¡œ ì§€ì •
credentials = service_account.Credentials.from_service_account_info(vision_api_key)
```

1. ì‚¬ìš©í•  ëª¨ë¸ ì„ ì–¸ ë° APIí‚¤ ë³´ë‚´ê¸°

```python
# Vision APIë¥¼ ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì„ ì–¸ + í™˜ê²½ ë³€ìˆ˜ ë‚´ì˜ API í‚¤ ì…ë ¥
client = vision.ImageAnnotatorClient(credentials=credentials)
```

1. ë°ì´í„° ì „ì²˜ë¦¬ ë° ì¶œë ¥ ì„¸íŒ… + ê²°ê³¼ ë°›ì•„ì˜¤ê¸°
   - Text_detection ê¸°ì¤€ ì½”ë“œ
     ```python
     # Base64ë¡œ ë””ì½”ë”© í•´ì¤ë‹ˆë‹¤. ì•ì˜ ë¶€ë¶„ì€ ìë¥´ê³  ë’¤ì˜ ì½”ë“œë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
         try:
             image = vision.Image(content=base64.b64decode(request.json['base64_drawing']))
         except base64.binascii.Error:
             print("400ì—ëŸ¬: ì˜³ì§€ ëª»í•œ Base64 ì½”ë“œ")
             response = Response(response='ì˜³ì§€ ëª»í•œ Base64 ì½”ë“œ', status=400, mimetype='application/json')
             return response

         # í•œêµ­ì–´ ì„¸íŒ…
         image_context = vision.ImageContext(language_hints=["ko"])

     		# ê²°ê³¼ê°’ ë°›ê¸°
         response = client.document_text_detection(image=image, image_context=image_context)
     ```
   - Web_detection ê¸°ì¤€ ì½”ë“œ
     ```python
     # Base64ë¡œ ë””ì½”ë”© í•´ì¤ë‹ˆë‹¤. ì•ì˜ ë¶€ë¶„ì€ ìë¥´ê³  ë’¤ì˜ ì½”ë“œë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
         try:
             decoded_image = base64.b64decode(request.json['base64_drawing'])
         except base64.binascii.Error:
             print("400ì—ëŸ¬: ì˜³ì§€ ëª»í•œ Base64 ì½”ë“œ")
             response = Response(response='ì˜³ì§€ ëª»í•œ Base64 ì½”ë“œ', status=400, mimetype='application/json')
             return response
             # return "ì˜³ì§€ ì•Šì€ Base_64 ì¸ì½”ë”© ì…ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."

         # PNG ì´ë¯¸ì§€ë¥¼ JPEG ì´ë¯¸ì§€ë¡œ ë³€í™˜
         image_rgba = Image.open(io.BytesIO(decoded_image)).convert('RGBA')
         image_rgb = Image.new("RGB", image_rgba.size, (255, 255, 255))
         image_rgb.paste(image_rgba, mask=image_rgba.split()[3])

         # ì´ë¯¸ì§€ ë¶„ì„ì„ ìœ„í•´ vision.Image ê°ì²´ ìƒì„±
         buffered = io.BytesIO()
         image_rgb.save(buffered, format="JPEG")
         image_content = buffered.getvalue()
         image = vision.Image(content=image_content)

         # =========== Web detection ìš© ì½”ë“œ =============#
         response = client.web_detection(image=image)
     ```
   - label_detection ê¸°ì¤€ ì½”ë“œ
     ```python
     # ë‚˜ë¨¸ì§€ ìœ„ì™€ ë™ì¼
     response_label = client.label_detection(image=image, max_results=40)
     ```

## 3. IMPort

### 1) index.htmlì— CDN ì„¤ì •

![Untitled 32](https://i.imgur.com/6czhKnG.png)

### 2) payment ì»´í¬ë„ŒíŠ¸ ìƒì„± í›„ ì½”ë“œ ê¸°ì…

```jsx
// payment ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì–´ì„œ, í•´ë‹¹ ì½”ë“œë¥¼ ê¸°ì…í•´ì¤ë‹ˆë‹¤.
// íŠ¹íˆ IMP.init("íšŒì›ê°€ì… í›„ ë°œê¸‰ ë°›ëŠ” ê²°ì œí‚¤"), pg: "kakaopay.{TC0ONETIME}"ë¥¼
// ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì–´ì•¼ ì œëŒ€ë¡œ ê²°ì œëª¨ë“ˆì´ ì‘ë™ë©ë‹ˆë‹¤.

import React from "react";

const Payment = () => {
  const onClickPayment = () => {
    const { IMP } = window;
    IMP.init("imp26454654"); // ê²°ì œ ë°ì´í„° ì •ì˜
    const data = {
      pg: "kakaopay.{TC0ONETIME}", // PGì‚¬ (í•„ìˆ˜í•­ëª©)
      pay_method: "card",
      merchant_uid: `mid_${new Date().getTime()}`, // ê²°ì œê¸ˆì•¡ (í•„ìˆ˜í•­ëª©)
      name: "ê²°ì œ í…ŒìŠ¤íŠ¸", // ì£¼ë¬¸ëª… (í•„ìˆ˜í•­ëª©)
      amount: "1000", // ê¸ˆì•¡ (í•„ìˆ˜í•­ëª©)
      // buyer_email: "test@portone.io",
      // buyer_name: "êµ¬ë§¤ìì´ë¦„",
      // buyer_tel: "010-1234-5678",
      // buyer_addr: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™",
      // buyer_postcode: "123-456",
      m_redirect_url: "{ëª¨ë°”ì¼ì—ì„œ ê²°ì œ ì™„ë£Œ í›„ ë¦¬ë””ë ‰ì…˜ ë  URL}",
    };
    IMP.request_pay(data, callback);
  };

  const callback = (response) => {
    const { success, error_msg, imp_uid, merchant_uid, pay_method, paid_amount, status } = response;
    if (success) {
      alert("ê²°ì œ ì„±ê³µ");
    } else {
      alert(`ê²°ì œ ì‹¤íŒ¨ : ${error_msg}`);
    }
  };

  return (
    <>
      <button onClick={onClickPayment}>ê²°ì œí•˜ê¸°</button>
    </>
  );
};

export default Payment;
```

### 3) ê²°ì œ í™”ë©´ í™•ì¸

![Untitled 33](https://i.imgur.com/6GHWhTv.png)
